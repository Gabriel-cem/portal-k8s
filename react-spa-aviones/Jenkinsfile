pipeline {
  agent {
    kubernetes {
      yamlFile 'react-spa-aviones/pod-template-buildah.yaml'
    }
  }
  environment {
    IMAGE_NAME = 'gab741/portal-aviones'
    IMAGE_TAG = 'latest'
    REGISTRY = 'docker.io'
  }
  stages {
    stage('Build Image') {
      steps {
        container('buildah') {
          sh '''
            buildah bud --isolation=chroot -t $REGISTRY/$IMAGE_NAME:$IMAGE_TAG .
          '''
        }
      }
    }
    stage('Login & Push') {
      steps {
        container('buildah') {
          withCredentials([usernamePassword(credentialsId: 'docker', usernameVariable: 'DOCKER_USER', passwordVariable: 'DOCKER_PASS')]) {
            sh '''
              buildah login -u $DOCKER_USER -p $DOCKER_PASS $REGISTRY
              buildah push $REGISTRY/$IMAGE_NAME:$IMAGE_TAG
            '''
          }
        }
      }
    }
  }
}
